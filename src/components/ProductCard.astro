---
interface Props {
    product: {
        id: string;
        name: string;
        slug: string;
        price: number;
        compare_price?: number | null;
        image: string;
        stock: number;
        is_featured?: boolean;
        categories?: { name: string; slug: string } | null;
    };
    index?: number;
}

const { product, index = 0 } = Astro.props;
const category = product.categories?.name || "Guantes";
const hasDiscount =
    product.compare_price && product.compare_price > product.price;
const discountPercent = hasDiscount
    ? Math.round(
          ((product.compare_price! - product.price) / product.compare_price!) *
              100,
      )
    : 0;
---

<article class={`card-product group reveal stagger-${(index % 4) + 1}`}>
    <!-- Image Container -->
    <a
        href={`/product/${product.slug}`}
        class="block aspect-[3/4] overflow-hidden relative"
        style="background-color: var(--bg-secondary);"
    >
        <img
            src={product.image}
            alt={product.name}
            loading="lazy"
            class="w-full h-full object-cover transition-transform duration-700 ease-out group-hover:scale-110"
        />

        <!-- Badges -->
        <div class="absolute top-4 left-4 flex flex-col gap-2 z-10">
            {product.is_featured && <span class="badge-pro">PRO</span>}
            {hasDiscount && <span class="badge-sale">-{discountPercent}%</span>}
            {
                product.stock < 5 && product.stock > 0 && (
                    <span class="badge bg-red-600 text-white">Últimas</span>
                )
            }
        </div>

        <!-- Hover Overlay -->
        <div
            class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-all duration-500"
        >
        </div>
    </a>

    <!-- Info -->
    <div class="p-5">
        <div class="flex justify-between items-start mb-1.5">
            <span
                class="text-[10px] font-bold text-brand uppercase tracking-[0.2em]"
            >
                {category}
            </span>
        </div>
        <a href={`/product/${product.slug}`}>
            <h3
                class="font-display text-base font-semibold uppercase tracking-tight group-hover:text-brand transition-colors duration-300 mb-2"
            >
                {product.name}
            </h3>
        </a>
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span
                    class="text-lg font-bold"
                    style="color: var(--text-primary);"
                    >€{product.price.toFixed(2)}</span
                >
                {
                    hasDiscount && (
                        <span
                            class="text-sm line-through"
                            style="color: var(--text-muted);"
                        >
                            €{product.compare_price!.toFixed(2)}
                        </span>
                    )
                }
            </div>

            <div></div>
        </div>
    </div>
</article>

<script>
    import { addItem } from "../lib/cart";

    function initProductCard() {
        document
            .querySelectorAll<HTMLButtonElement>(".add-to-cart-quick")
            .forEach((btn) => {
                if (btn.dataset.bound === "1") return;
                btn.dataset.bound = "1";

                btn.addEventListener("click", async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (btn.disabled) return;

                    const iconAdd =
                        btn.querySelector<SVGElement>(".btn-icon-add");
                    const iconSpin =
                        btn.querySelector<SVGElement>(".btn-icon-spin");

                    // Loading state
                    btn.disabled = true;
                    iconAdd?.classList.add("hidden");
                    iconSpin?.classList.remove("hidden");

                    try {
                        const ok = await addItem({
                            id: btn.dataset.id!,
                            name: btn.dataset.name!,
                            price: parseFloat(btn.dataset.price!),
                            image: btn.dataset.image!,
                            stock: parseInt(btn.dataset.stock!),
                            slug: btn.dataset.slug!,
                        });
                    } finally {
                        // Restore button
                        iconSpin?.classList.add("hidden");
                        iconAdd?.classList.remove("hidden");
                        const stock = parseInt(btn.dataset.stock!);
                        btn.disabled = stock <= 0;
                    }
                });
            });
    }

    document.addEventListener("astro:page-load", initProductCard);
</script>
