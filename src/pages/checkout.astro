---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
---

<Layout title="Pago Seguro">
    <Header />
    <main
        class="min-h-screen py-24"
        style="background-color: var(--bg-primary);"
    >
        <div class="container max-w-4xl">
            <!-- Breadcrumb -->
            <div
                class="flex items-center gap-2 text-xs uppercase tracking-[0.2em] mb-8"
                style="color: var(--text-muted);"
            >
                <a href="/" class="hover:text-brand transition-colors">Inicio</a
                >
                <span>/</span>
                <a href="/cart" class="hover:text-brand transition-colors"
                    >Carrito</a
                >
                <span>/</span>
                <span style="color: var(--text-secondary);">Checkout</span>
            </div>

            <h1 class="section-title mb-12">
                Finalizar <span class="text-brand">Compra</span>
            </h1>

            <div
                id="checkout-form-container"
                class="grid grid-cols-1 md:grid-cols-2 gap-12 lg:gap-16"
            >
                <!-- Shipping Info -->
                <section class="space-y-6">
                    <div class="flex items-center gap-3 text-brand mb-2">
                        <svg
                            class="w-5 h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="1.5"
                                d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"
                            ></path>
                        </svg>
                        <h2
                            class="font-display text-lg font-semibold uppercase tracking-tight"
                        >
                            Datos de Envío
                        </h2>
                    </div>

                    <form id="checkout-form" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input
                                placeholder="Nombre"
                                required
                                class="input"
                            />
                            <input
                                placeholder="Apellidos"
                                required
                                class="input"
                            />
                        </div>
                        <input placeholder="Dirección" required class="input" />
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input
                                placeholder="Ciudad"
                                required
                                class="input"
                            />
                            <input
                                placeholder="Código Postal"
                                required
                                class="input"
                            />
                        </div>
                        <input
                            placeholder="Teléfono"
                            type="tel"
                            class="input"
                        />
                    </form>
                </section>

                <!-- Payment -->
                <section class="space-y-6">
                    <div class="flex items-center gap-3 text-brand mb-2">
                        <svg
                            class="w-5 h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="1.5"
                                d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"
                            ></path>
                        </svg>
                        <h2
                            class="font-display text-lg font-semibold uppercase tracking-tight"
                        >
                            Método de Pago
                        </h2>
                    </div>

                    <div class="card p-6 space-y-4">
                        <div
                            class="flex items-center justify-between p-4 bg-brand/5 border border-brand/20"
                        >
                            <span
                                class="font-semibold text-sm flex items-center gap-2"
                            >
                                <svg
                                    class="w-4 h-4 text-brand"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"
                                    ></path>
                                </svg>
                                Tarjeta de Crédito
                            </span>
                            <svg
                                class="w-4 h-4 text-brand"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <p
                            class="text-[10px] uppercase tracking-[0.2em] text-center"
                            style="color: var(--text-muted);"
                        >
                            Transacción segura y encriptada
                        </p>
                    </div>

                    <button
                        id="place-order-btn"
                        class="btn-glow w-full h-14 flex items-center justify-center gap-3 text-base"
                    >
                        Pagar y Finalizar
                        <svg
                            class="w-5 h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M5 13l4 4L19 7"></path>
                        </svg>
                    </button>
                </section>
            </div>

            <!-- Success State -->
            <div id="success-message" class="hidden py-24 text-center">
                <div
                    class="w-20 h-20 bg-brand text-black flex items-center justify-center mx-auto mb-8"
                >
                    <svg
                        class="w-10 h-10"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h2 class="section-title mb-4">
                    ¡Pedido <span class="text-brand">Confirmado</span>!
                </h2>
                <p
                    class="mb-8 max-w-md mx-auto"
                    style="color: var(--text-muted);"
                >
                    Gracias por confiar en PARRA. Recibirás un email con los
                    detalles de tu pedido.
                </p>
                <a href="/profile" class="btn-outline inline-flex"
                    >Ver mis pedidos</a
                >
            </div>
        </div>
    </main>
    <Footer />
</Layout>

<script>
    import { getCart, getSessionId } from "../lib/cart";

    function initCheckoutPage() {
        var orderBtn = document.getElementById(
            "place-order-btn",
        ) as HTMLButtonElement;
        var checkoutForm = document.getElementById(
            "checkout-form",
        ) as HTMLFormElement;

        if (orderBtn && checkoutForm) {
            orderBtn.addEventListener("click", async function (e) {
                e.preventDefault();

                // Validate form
                if (!checkoutForm.checkValidity()) {
                    checkoutForm.reportValidity();
                    return;
                }

                const items = getCart();
                if (items.length === 0) {
                    const { toast } = await import('../lib/toast');
                    toast.warning('Tu carrito está vacío.');
                    return;
                }

                const cartSessionId = getSessionId();
                const formData = new FormData(checkoutForm);
                const shippingInfo = {
                    firstName: (
                        document.querySelector(
                            'input[placeholder="Nombre"]',
                        ) as HTMLInputElement
                    )?.value,
                    lastName: (
                        document.querySelector(
                            'input[placeholder="Apellidos"]',
                        ) as HTMLInputElement
                    )?.value,
                    address: (
                        document.querySelector(
                            'input[placeholder="Dirección"]',
                        ) as HTMLInputElement
                    )?.value,
                    city: (
                        document.querySelector(
                            'input[placeholder="Ciudad"]',
                        ) as HTMLInputElement
                    )?.value,
                    zip: (
                        document.querySelector(
                            'input[placeholder="Código Postal"]',
                        ) as HTMLInputElement
                    )?.value,
                    phone: (
                        document.querySelector(
                            'input[placeholder="Teléfono"]',
                        ) as HTMLInputElement
                    )?.value,
                };

                const emailInput = document.querySelector(
                    'input[type="email"]',
                ) as HTMLInputElement;
                const email = emailInput?.value || "guest@example.com"; // Should ideally have an email field

                orderBtn.innerHTML =
                    '<span class="flex items-center gap-2"><svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Redirigiendo a Stripe...</span>';
                orderBtn.setAttribute("disabled", "true");

                try {
                    const response = await fetch("/api/stripe/create-session", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            items,
                            shippingInfo,
                            email,
                            cartSessionId,
                        }),
                    });

                    const data = await response.json();

                    if (data.url) {
                        window.location.href = data.url;
                    } else {
                        throw new Error(
                            data.error || "Error al crear sesión de pago",
                        );
                    }
                } catch (err) {
                    const { toast } = await import('../lib/toast');
                    toast.error(
                        err.message ||
                            "Error al procesar el pago. Intenta de nuevo."
                    );
                    orderBtn.textContent = "Pagar y Finalizar";
                    orderBtn.removeAttribute("disabled");
                }
            });
        }
    }

    document.addEventListener("astro:page-load", initCheckoutPage);
</script>
