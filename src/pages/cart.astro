---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
---

<Layout title="Mi Carrito">
    <Header />
    <main class="min-h-screen" style="background-color: var(--bg-primary);">
        <!-- Breadcrumb -->
        <div class="container pt-24">
            <div
                class="flex items-center gap-2 text-xs uppercase tracking-[0.2em] mb-8"
                style="color: var(--text-muted);"
            >
                <a href="/" class="hover:text-brand transition-colors">Inicio</a
                >
                <span>/</span>
                <span style="color: var(--text-secondary);">Carrito</span>
            </div>
            <h1 class="section-title mb-12">
                Tu <span class="text-brand">Equipo</span>
            </h1>
        </div>

        <div class="container pb-24">
            <div
                id="cart-container"
                class="grid grid-cols-1 lg:grid-cols-3 gap-12 lg:gap-16"
            >
                <!-- Cart Items -->
                <div class="lg:col-span-2 space-y-6">
                    <div id="cart-items-list" class="space-y-4">
                        <!-- Skeleton Loading -->
                        <div class="animate-pulse space-y-4">
                            <div
                                class="h-28"
                                style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);"
                            >
                            </div>
                            <div
                                class="h-28"
                                style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);"
                            >
                            </div>
                        </div>
                    </div>

                    <div id="empty-cart" class="hidden py-24 text-center">
                        <div
                            class="w-20 h-20 mx-auto mb-6 flex items-center justify-center"
                            style="border: 1px solid var(--border-color);"
                        >
                            <svg
                                class="w-8 h-8"
                                style="color: var(--text-muted);"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="1.5"
                                    d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
                                ></path>
                            </svg>
                        </div>
                        <p
                            class="uppercase tracking-[0.2em] text-sm mb-8"
                            style="color: var(--text-muted);"
                        >
                            Tu carrito está vacío
                        </p>
                        <a href="/shop" class="btn-primary inline-flex">
                            Ir a la tienda
                            <svg
                                class="w-4 h-4 ml-2"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                            </svg>
                        </a>
                    </div>
                </div>

                <!-- Summary Sidebar -->
                <div class="lg:col-span-1">
                    <div class="card p-8 sticky top-24">
                        <h3
                            class="font-display text-xl font-bold uppercase tracking-tight mb-8"
                        >
                            Resumen
                        </h3>

                        <div class="space-y-4 mb-8 text-sm">
                            <div
                                class="flex justify-between text-sm"
                                style="color: var(--text-muted);"
                            >
                                <span class="uppercase tracking-wider"
                                    >Subtotal</span
                                >
                                <span
                                    id="subtotal"
                                    class="font-semibold"
                                    style="color: var(--text-primary);"
                                    >€0.00</span
                                >
                            </div>
                            <div
                                class="flex justify-between text-sm"
                                style="color: var(--text-muted);"
                            >
                                <span class="uppercase tracking-wider"
                                    >Envío</span
                                >
                                <span class="text-brand font-semibold"
                                    >Gratis</span
                                >
                            </div>
                            <div
                                class="pt-4 flex justify-between"
                                style="border-top: 1px solid var(--border-color);"
                            >
                                <span
                                    class="text-lg font-bold uppercase tracking-wider"
                                    >Total</span
                                >
                                <span
                                    id="total"
                                    class="text-lg font-bold text-brand"
                                    >€0.00</span
                                >
                            </div>
                        </div>

                        <!-- Coupon -->
                        <div class="mb-8">
                            <div class="flex gap-2">
                                <input
                                    type="text"
                                    placeholder="Código descuento"
                                    class="input flex-1 !text-xs !py-2.5"
                                />
                                <button
                                    class="btn-outline !py-2.5 !px-4 !text-xs !border"
                                >
                                    Aplicar
                                </button>
                            </div>
                        </div>

                        <a
                            href="/checkout"
                            id="checkout-btn"
                            class="btn-glow w-full flex items-center justify-center gap-3 h-14"
                        >
                            Tramitar Pedido
                            <svg
                                class="w-4 h-4"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                            </svg>
                        </a>

                        <div
                            class="mt-6 flex items-center justify-center gap-4 opacity-20"
                        >
                            <span class="text-xs font-bold tracking-wider"
                                >Visa</span
                            >
                            <span class="text-xs font-bold tracking-wider"
                                >MC</span
                            >
                            <span class="text-xs font-bold tracking-wider"
                                >PayPal</span
                            >
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <Footer />
</Layout>

<script>
    import { getCart, removeItem, updateQty, cartTotal } from "../lib/cart";
    import type { CartItem } from "../lib/cart";

    let busyKeys = new Set<string>();

    function ikey(item: CartItem) {
        return item.variantId && item.variantId !== '' ? item.variantId : item.id;
    }

    function fmt(n: number) {
        return '€' + n.toFixed(2);
    }

    const SPINNER = `<svg class="w-4 h-4 animate-spin inline-block" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
    </svg>`;

    function initCartPage() {
        const list        = document.getElementById("cart-items-list");
        const empty       = document.getElementById("empty-cart");
        const subtotalEl  = document.getElementById("subtotal");
        const totalEl     = document.getElementById("total");
        const cartContainer = document.getElementById("cart-container");

        function render() {
            const items = getCart();
            if (!list || !empty || !subtotalEl || !totalEl || !cartContainer) return;

            if (items.length === 0) {
                cartContainer.classList.add("hidden");
                empty.classList.remove("hidden");
                return;
            }

            cartContainer.classList.remove("hidden");
            empty.classList.add("hidden");

            const total = cartTotal();
            subtotalEl.textContent = fmt(total);
            totalEl.textContent    = fmt(total);

            list.innerHTML = items.map(item => {
                const key  = ikey(item);
                const busy = busyKeys.has(key);
                const atMax = item.stock > 0 && item.quantity >= item.stock;

                return `<div
                    class="flex items-center gap-6 p-5 card group transition-opacity duration-200 ${busy ? 'opacity-50 pointer-events-none' : ''}"
                    data-key="${key}"
                >
                    <div class="w-24 h-24 flex-shrink-0 overflow-hidden bg-[var(--bg-secondary)] border border-[var(--border-color)]">
                        <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" loading="lazy"/>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start mb-2 gap-4">
                            <div>
                                <h3 class="font-display font-bold uppercase tracking-tight text-base mb-1">${item.name}</h3>
                                ${item.size ? `<p class="text-[10px] text-brand font-bold uppercase tracking-widest">Talla ${item.size}</p>` : ''}
                                ${item.stock > 0 && item.quantity >= item.stock
                                    ? `<p class="text-[10px] text-amber-400 font-semibold mt-0.5">Stock maximo alcanzado</p>`
                                    : ''}
                            </div>
                            <span class="font-bold text-lg">${fmt(item.price * item.quantity)}</span>
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <div class="flex items-center border border-[var(--border-color)] divide-x divide-[var(--border-color)]">
                                <button class="qty-btn-page w-9 h-9 flex items-center justify-center text-[var(--text-muted)] hover:text-white transition-colors"
                                    data-action="dec" data-id="${item.id}" data-variant="${item.variantId || ''}" data-key="${key}"
                                    ${busy ? 'disabled' : ''}>
                                    ${busy ? SPINNER : '−'}
                                </button>
                                <span class="text-sm font-bold w-10 text-center tabular-nums select-none">${item.quantity}</span>
                                <button class="qty-btn-page w-9 h-9 flex items-center justify-center text-[var(--text-muted)] hover:text-white transition-colors"
                                    data-action="inc" data-id="${item.id}" data-variant="${item.variantId || ''}" data-key="${key}"
                                    ${busy || atMax ? 'disabled' : ''}
                                    title="${atMax ? 'Stock maximo' : ''}">
                                    ${busy ? SPINNER : '+'}
                                </button>
                            </div>
                            <button class="remove-btn-page text-xs uppercase font-bold tracking-widest text-[var(--text-muted)] hover:text-red-500 transition-colors flex items-center gap-2"
                                    data-id="${item.id}" data-variant="${item.variantId || ''}" data-key="${key}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                                Eliminar
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');

            // Event Listeners
            list.querySelectorAll<HTMLButtonElement>('.remove-btn-page').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const key = btn.dataset.key!;
                    busyKeys.add(key);
                    render();
                    await removeItem(btn.dataset.id!, btn.dataset.variant || undefined);
                    busyKeys.delete(key);
                });
            });

            list.querySelectorAll<HTMLButtonElement>('.qty-btn-page').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const key    = btn.dataset.key!;
                    const id     = btn.dataset.id!;
                    const vId    = btn.dataset.variant || undefined;
                    const action = btn.dataset.action!;
                    const item   = getCart().find(i => ikey(i) === key);
                    if (!item) return;
                    const newQty = action === 'inc' ? item.quantity + 1 : item.quantity - 1;
                    busyKeys.add(key);
                    render();
                    await updateQty(id, vId, newQty);
                    busyKeys.delete(key);
                    render();
                });
            });
        }

        window.addEventListener('cart:updated', render);
        render();
    }

    document.addEventListener('astro:page-load', initCartPage);
</script>
