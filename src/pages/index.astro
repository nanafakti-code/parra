---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Hero from "../components/Hero.astro";
import ProductCard from "../components/ProductCard.astro";
import Benefits from "../components/Benefits.astro";
import GloveSelector from "../components/GloveSelector.astro";
import Testimonials from "../components/Testimonials.astro";
import Newsletter from "../components/Newsletter.astro";
import Footer from "../components/Footer.astro";
import { supabase } from "../lib/supabase";

let products: any[] = [];

try {
	// 1. Intentar obtener productos destacados
	const { data: featuredData, error: featuredError } = await supabase
		.from("products")
		.select("*, categories(name, slug)")
		.eq("is_featured", true)
		.eq("is_active", true)
		.order("created_at", { ascending: false })
		.limit(4);

	if (featuredError) {
		console.error("Error cargando destacados:", featuredError.message);
	}

	products = featuredData || [];

	// 2. Fallback: Si no hay destacados, cargar los 4 más recientes activos
	if (products.length === 0) {
		const { data: recentData, error: recentError } = await supabase
			.from("products")
			.select("*, categories(name, slug)")
			.eq("is_active", true)
			.order("created_at", { ascending: false })
			.limit(4);

		if (recentError) {
			console.error(
				"Error cargando productos fallback:",
				recentError.message,
			);
		}
		products = recentData || [];
	}
} catch (e) {
	console.error("Error crítico en home SSR:", e);
}
---

<Layout
	title="Inicio"
	description="PARRA — Guantes de portero profesionales. Agarre extremo, tecnología alemana, diseño premium."
>
	<Header />
	<main>
		<!-- Hero -->
		<Hero />

		<!-- Featured Products -->
		<section class="section" style="background-color: var(--bg-primary);">
			<div class="container">
				<div
					class="flex flex-col md:flex-row justify-between items-start md:items-end mb-14 gap-6"
				>
					<div>
						<h2 class="section-title">
							Productos <span class="text-brand">Destacados</span>
						</h2>
						<p class="section-subtitle">
							Nuestra selección de los guantes más vendidos.
							Tecnología de vanguardia para porteros exigentes.
						</p>
					</div>
					<a href="/shop" class="btn-outline group shrink-0">
						Ver toda la tienda
						<svg
							class="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
						</svg>
					</a>
				</div>

				<div
					class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8"
				>
					{
						(products || []).map((product: any, i: number) => (
							<ProductCard product={product} index={i} />
						))
					}
				</div>
			</div>
		</section>

		<!-- Benefits -->
		<Benefits />

		<!-- Glove Selector -->
		<GloveSelector />

		<!-- Testimonials -->
		<Testimonials />

		<!-- CTA Banner -->
		<section
			class="relative h-[40vh] md:h-[50vh] lg:h-[60vh] flex items-center overflow-hidden"
		>
			<div
				class="absolute inset-0 bg-[url('https://res.cloudinary.com/djvj32zic/image/upload/v1771869186/b6c3767d-ca9e-49a5-8187-b0610793ba75_zgic3i.png')] bg-cover bg-scroll md:bg-fixed bg-center"
			>
				<div class="absolute inset-0 bg-black/70"></div>
			</div>
			<div class="container relative z-10 text-center reveal">
				<h2
					class="text-3xl md:text-5xl lg:text-8xl font-display font-bold uppercase tracking-tighter mb-6 md:mb-8"
				>
					¿LISTO PARA<br />
					<span class="text-brand">VOLAR?</span>
				</h2>
				<a href="/register" class="btn-glow inline-flex">
					Únete al Club PARRA
					<svg
						class="w-4 h-4 ml-2"
						fill="none"
						stroke="currentColor"
						viewBox="0 0 24 24"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
					</svg>
				</a>
			</div>
		</section>

		<!-- Newsletter -->
		<Newsletter />
	</main>
	<Footer />
</Layout>
